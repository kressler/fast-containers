#!/bin/bash
#
# Pre-commit hook that automatically formats C++ files with clang-format
# before committing them.
#
# This hook:
# 1. Finds all staged C++ files (.cpp, .hpp, .ipp)
# 2. Runs clang-format on them
# 3. Re-stages any files that were modified
# 4. Continues with the commit

# Check if clang-format is available
if ! command -v clang-format &> /dev/null; then
    echo "Warning: clang-format not found. Skipping formatting."
    echo "Install clang-format to enable automatic code formatting."
    exit 0
fi

# Get list of staged C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|hpp|ipp)$')

if [ -z "$STAGED_FILES" ]; then
    # No C++ files staged, nothing to format
    exit 0
fi

echo "Running clang-format on staged C++ files..."

# Format each staged file
FILES_FORMATTED=0
for file in $STAGED_FILES; do
    # Only format if file exists (handles deleted files)
    if [ -f "$file" ]; then
        echo "  Formatting: $file"
        clang-format -i "$file"
        git add "$file"
        FILES_FORMATTED=$((FILES_FORMATTED + 1))
    fi
done

if [ $FILES_FORMATTED -gt 0 ]; then
    echo "Formatted $FILES_FORMATTED C++ file(s)"
fi

exit 0
